<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renty Club | Espacios Únicos</title>
    
    <link rel="stylesheet" href="assets/css/styles.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="assets/js/config.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-offwhite font-sans text-gray-800 antialiased">

    <nav class="bg-white fixed w-full z-50 top-0 border-b border-gray-100 h-20 flex items-center">
        <div class="container mx-auto px-6 flex justify-between items-center w-full">
            <a href="index.html" class="flex items-center gap-3 group">
                <div class="w-9 h-9 bg-black text-white flex items-center justify-center font-serif text-xl italic">R</div>
                <span class="text-xl font-serif font-bold tracking-tight text-black">RentyClub</span>
            </a>
            <div id="nav-right" class="flex items-center gap-8"></div>
        </div>
    </nav>

    <div class="container mx-auto px-6 pt-28 pb-16 max-w-2xl">
        <h1 class="font-serif text-3xl font-bold text-black mb-8">Mi Perfil</h1>
        <div class="bg-white shadow-2xl border border-gray-100 p-8 rc-hover-lift">
            <div class="flex items-center gap-6 mb-8">
                <div class="w-20 h-20 bg-black text-white rounded-full flex items-center justify-center text-3xl font-bold border-2 border-gray-200 overflow-hidden" id="avatar-placeholder">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="display-name">Cargando...</h1>
                    <p class="text-gray-500" id="display-email">...</p>
                    <span id="display-role" class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded mt-2 inline-block uppercase font-bold">...</span>
                </div>
            </div>

            <form id="profile-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Nombre Completo</label>
                    <input type="text" id="full-name" class="w-full p-3 border border-gray-300 rounded focus:border-black outline-none transition">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Avatar (URL Imagen)</label>
                    <input type="url" id="avatar-url" class="w-full p-3 border border-gray-300 rounded focus:border-black outline-none transition" placeholder="https://...">
                </div>

                <div id="msg" class="hidden p-3 rounded text-center text-sm font-bold"></div>

                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" onclick="window.location.href='index.html'" class="text-gray-500 font-bold hover:text-black">Cancelar</button>
                    <button type="submit" class="bg-black text-white px-6 py-3 rounded font-bold hover:bg-gray-800 shadow transition">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN TUS CLAVES
        const supabaseUrl = 'https://pmedrqauhesybkzxraxd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtZWRycWF1aGVzeWJrenhyYXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTQyNTIsImV4cCI6MjA4NTk5MDI1Mn0.DnC8YSij2mN-gR3kcnYzjhVmy1HXKcul_TcXzAjcI-I';
        
        const db = supabase.createClient(supabaseUrl, supabaseKey);
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await db.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            currentUser = session.user;
            await loadOrRepairProfile();
        });

        async function loadOrRepairProfile() {
            // 1. Intentar buscar perfil
            let { data: profile, error } = await db.from('profiles').select('*').eq('id', currentUser.id).single();

            // 2. Si no existe, lo creamos (AUTO-REPARACIÓN)
            if (!profile) {
                console.log("Perfil no encontrado. Creando uno nuevo...");
                const { data: newProfile, error: insertError } = await db.from('profiles').insert({
                    id: currentUser.id,
                    email: currentUser.email,
                    role: 'user',
                    full_name: ''
                }).select().single();
                
                if (insertError) {
                    alert("Error crítico creando perfil: " + insertError.message);
                    return;
                }
                profile = newProfile;
            }

            // 3. Llenar UI
            document.getElementById('display-email').innerText = profile.email;
            document.getElementById('display-name').innerText = profile.full_name || 'Sin Nombre';
            document.getElementById('display-role').innerText = profile.role;
            document.getElementById('full-name').value = profile.full_name || '';
            document.getElementById('avatar-url').value = profile.avatar_url || '';
            
            if (profile.avatar_url) {
                document.getElementById('avatar-placeholder').innerHTML = `<img src="${profile.avatar_url}" class="w-full h-full object-cover">`;
                document.getElementById('avatar-placeholder').classList.remove('bg-black', 'text-white', 'p-4');
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerText = "Guardando..."; btn.disabled = true;

            const { error } = await db.from('profiles').update({
                full_name: document.getElementById('full-name').value,
                avatar_url: document.getElementById('avatar-url').value,
            }).eq('id', currentUser.id);

            const msg = document.getElementById('msg');
            msg.classList.remove('hidden');
            
            if (error) {
                msg.innerText = "Error: " + error.message;
                msg.className = "bg-red-100 text-red-600 p-3 rounded block mt-4";
            } else {
                msg.innerText = "¡Datos actualizados!";
                msg.className = "bg-green-100 text-green-600 p-3 rounded block mt-4";
                setTimeout(() => location.reload(), 1000);
            }
            btn.innerText = "Guardar Cambios"; btn.disabled = false;
        });
    </script>
</body>
</html>