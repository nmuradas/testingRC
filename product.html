<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle - Renty Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_green.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { black: '#0F0F0F', graybg: '#FAFAFA' },
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], serif: ['"Playfair Display"', 'serif'] },
                    boxShadow: { 'soft': '0 20px 40px -10px rgba(0,0,0,0.1)' }
                }
            }
        }
    </script>
</head>
<body class="bg-white text-black font-sans antialiased">

    <nav class="border-b border-gray-100 p-4 sticky top-0 bg-white/95 backdrop-blur z-50 h-20">
        <div class="container mx-auto px-6 flex justify-between items-center h-full">
            <a href="index.html" class="flex items-center gap-2 group">
                <i class="fa-solid fa-arrow-left text-lg group-hover:-translate-x-1 transition text-black"></i>
                <span class="font-bold text-sm tracking-wide text-black">Volver al inicio</span>
            </a>
            <div class="font-serif font-bold text-xl tracking-tight">RentyClub</div>
            <div class="w-20"></div> </div>
    </nav>

    <main class="container mx-auto px-6 py-10 max-w-7xl">
        
        <div id="loader" class="text-center py-40">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-gray-200"></i>
        </div>

        <div id="product-content" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-12">
            
            <div class="lg:col-span-8 space-y-10">
                
                <div class="h-[500px] w-full rounded-3xl overflow-hidden shadow-sm relative bg-gray-100 group">
                    <img id="p-image" src="" class="w-full h-full object-cover transition duration-700 group-hover:scale-105" onerror="this.src='https://via.placeholder.com/800x600?text=Sin+Imagen'">
                    <span id="p-type" class="absolute top-6 left-6 bg-white/90 backdrop-blur px-4 py-1.5 text-xs font-bold uppercase tracking-widest rounded-full shadow-sm"></span>
                </div>

                <div class="border-b border-gray-100 pb-8">
                    <h1 id="p-title" class="font-serif text-4xl md:text-5xl font-bold mb-4 text-black leading-tight"></h1>
                    <div class="flex items-center gap-4 text-gray-500 text-sm font-medium">
                        <span class="flex items-center gap-1 text-black"><i class="fa-solid fa-location-dot"></i> <span id="p-location" class="underline decoration-gray-300 underline-offset-4"></span></span>
                        <span>•</span>
                        <span class="flex items-center gap-1"><i class="fa-solid fa-star text-black"></i> 4.9 (18 reseñas)</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-bold text-xl font-serif text-black">Acerca de este espacio</h3>
                    <p id="p-desc" class="text-gray-600 leading-8 text-lg font-light"></p>
                </div>

                <!-- AMENITIES -->
                <div id="amenities-section" class="space-y-5 pt-2 hidden">
                    <h3 class="font-bold text-xl font-serif text-black">Amenities</h3>
                    <div id="p-amenities" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                </div>

                <div class="pt-6 border-t border-gray-100">
                    <h3 class="font-bold text-xl font-serif mb-6 text-black">Ubicación</h3>
                    <div id="map" class="h-96 w-full rounded-3xl border border-gray-200 z-0 shadow-sm"></div>
                </div>
            </div>

            <div class="lg:col-span-4 relative">
                <div class="sticky top-28 space-y-6">
                    
                    <div class="bg-white p-8 rounded-3xl shadow-soft border border-gray-100">
                        <div class="flex justify-between items-end mb-8 border-b border-gray-50 pb-6">
                            <div>
                                <span id="p-price" class="text-4xl font-serif font-bold text-black"></span>
                                <span class="text-gray-400 font-light text-sm"> / noche</span>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-2xl overflow-hidden mb-6">
                            <div class="grid grid-cols-2">
                                <div class="p-3 border-r border-gray-200 bg-gray-50/50 hover:bg-gray-50 transition cursor-pointer relative">
                                    <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1 tracking-wider">Llegada</label>
                                    <input id="start-date" class="w-full bg-transparent outline-none font-bold text-sm text-black cursor-pointer placeholder-gray-300" placeholder="Fecha">
                                </div>
                                <div class="p-3 bg-gray-50/50 hover:bg-gray-50 transition cursor-pointer relative">
                                    <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1 tracking-wider">Salida</label>
                                    <input id="end-date" class="w-full bg-transparent outline-none font-bold text-sm text-black cursor-pointer placeholder-gray-300" placeholder="Fecha" disabled>
                                </div>
                            </div>
                        </div>

                        <button onclick="handleBooking()" class="w-full bg-black text-white py-4 rounded-xl font-bold hover:scale-[1.02] active:scale-[0.98] transition shadow-lg text-xs uppercase tracking-widest">
                            Solicitar Reserva
                        </button>
                        
                        <div id="summary" class="hidden mt-6 pt-6 border-t border-gray-100 space-y-3 text-sm text-gray-600">
                            <div class="flex justify-between"><span><span id="summ-days">0</span> noches</span><span>$<span id="summ-subtotal">0</span></span></div>
                            <div class="flex justify-between"><span>Tarifa servicio</span><span>$<span id="summ-fee">0</span></span></div>
                            <div class="flex justify-between font-bold text-black text-lg pt-2 border-t border-gray-100 mt-2"><span>Total</span><span>$<span id="summ-total">0</span></span></div>
                        </div>
                    </div>

                    <div class="bg-graybg p-6 rounded-2xl border border-gray-100">
                        <h4 class="font-bold text-sm mb-3 text-black">¿Tienes dudas?</h4>
                        <textarea id="contact-msg" class="w-full bg-white border border-gray-200 p-3 rounded-xl text-sm mb-3 outline-none focus:border-black resize-none transition" rows="3" placeholder="Hola, me interesa saber..."></textarea>
                        <button onclick="contactOwner()" class="w-full bg-white border border-gray-300 text-black py-2.5 rounded-xl font-bold hover:bg-black hover:text-white hover:border-black transition text-xs uppercase tracking-wide">
                            Enviar Mensaje
                        </button>
                    </div>

                </div>
            </div>

        </div>
    </main>

    <script src="assets/js/app.js"></script>
    <script>
        // CLIENTE DE DB
        const pageDb = supabase.createClient(
            'https://pmedrqauhesybkzxraxd.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtZWRycWF1aGVzeWJrenhyYXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTQyNTIsImV4cCI6MjA4NTk5MDI1Mn0.DnC8YSij2mN-gR3kcnYzjhVmy1HXKcul_TcXzAjcI-I'
        );

        let currentPrice = 0, ownerId = null, spaceId = null, disabledDates = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            spaceId = params.get('id');
            if(!spaceId) location.href = 'index.html';
            
            // Verificar sesión para mostrar avatar o menú (opcional)
            const { data: { session } } = await pageDb.auth.getSession();
            currentUser = session?.user || null;

            await loadSpaceDetails();
        });

        async function loadSpaceDetails() {
            const { data: space, error } = await pageDb.from('spaces').select('*, bookings(*)').eq('id', spaceId).single();
            
            if (error || !space) { 
                document.getElementById('loader').innerHTML = '<p class="text-red-500">Propiedad no encontrada.</p>';
                setTimeout(() => location.href = 'index.html', 2000);
                return; 
            }

            // Filtrar fechas ocupadas
            if (space.bookings) {
                space.bookings.forEach(b => {
                    if (b.status === 'approved' || b.status === 'blocked') {
                        disabledDates.push({ from: b.start_date, to: b.end_date });
                    }
                });
            }

            // Llenar datos
            document.getElementById('p-title').innerText = space.title || 'Sin Título';
            document.getElementById('p-location').innerText = space.location || 'Ubicación no especificada';
            document.getElementById('p-desc').innerText = space.description || 'Sin descripción.';
            document.getElementById('p-type').innerText = space.type || 'Espacio';
            document.getElementById('p-image').src = space.image || 'https://via.placeholder.com/800x600';
            
            // Formato de precio Argentina
            const fmt = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });
            document.getElementById('p-price').innerText = fmt.format(space.price);
            
            currentPrice = space.price; 
            ownerId = space.owner_id;

            // Amenities
            renderAmenities(space.amenities);

            // Mostrar contenido
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('product-content').classList.remove('hidden');

            // Mapa
            if (space.lat && space.lng) {
                setTimeout(() => {
                    const map = L.map('map', { scrollWheelZoom: false }).setView([space.lat, space.lng], 15);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'
                    }).addTo(map);
                    // Icono personalizado negro (estilo premium)
                    const blackIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: "<div style='background-color:#000;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 5px rgba(0,0,0,0.3);'></div>",
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                    L.marker([space.lat, space.lng], {icon: blackIcon}).addTo(map).bindPopup(`<b style="font-family:sans-serif">${space.title}</b>`).openPopup();
                    map.invalidateSize();
                }, 300);
            } else {
                document.getElementById('map').innerHTML = '<div class="h-full flex items-center justify-center bg-gray-50 text-gray-400 rounded-3xl text-sm">Ubicación exacta no disponible en mapa</div>';
            }

            // Calendarios
            const endPicker = flatpickr("#end-date", { locale: "es", dateFormat: "Y-m-d", minDate: "today", disable: disabledDates });
            flatpickr("#start-date", {
                locale: "es", dateFormat: "Y-m-d", minDate: "today", disable: disabledDates,
                onChange: (d, s) => { 
                    endPicker.set('minDate', s); 
                    document.getElementById('end-date').disabled = false; 
                    setTimeout(() => endPicker.open(), 100); 
                }
            });
            document.getElementById('end-date').addEventListener('change', calcTotal);
        }

        function renderAmenities(amenities) {
            const section = document.getElementById('amenities-section');
            const container = document.getElementById('p-amenities');
            if (!section || !container) return;

            const list = Array.isArray(amenities) ? amenities.filter(Boolean) : [];
            if (list.length === 0) {
                section.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            // Mapa: amenity -> FontAwesome icon
            const iconByAmenity = {
                'Seguridad 24hs': 'fa-shield-halved',
                'Calefacción': 'fa-fire',
                'Baño privado': 'fa-toilet',
                'Cocina': 'fa-utensils',
                'Cochera': 'fa-car',
                'Vidriera': 'fa-store',
                'Aire Acondicionado': 'fa-snowflake',
                'WiFi': 'fa-wifi'
            };

            container.innerHTML = list.map(a => {
                const icon = iconByAmenity[a] || 'fa-circle-check';
                return `
                    <div class="flex items-center gap-3 border border-gray-200 bg-white rounded-2xl px-4 py-3">
                        <div class="w-9 h-9 rounded-xl bg-gray-50 border border-gray-200 flex items-center justify-center">
                            <i class="fa-solid ${icon} text-black"></i>
                        </div>
                        <div class="text-sm font-semibold text-black">${escapeHtml(a)}</div>
                    </div>
                `;
            }).join('');

            section.classList.remove('hidden');
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function calcTotal() {
            const startStr = document.getElementById('start-date').value;
            const endStr = document.getElementById('end-date').value;
            if (startStr && endStr) {
                const start = new Date(startStr);
                const end = new Date(endStr);
                
                let valid = true;
                disabledDates.forEach(d => { if (new Date(d.from) >= start && new Date(d.to) <= end) valid = false; });
                
                if (!valid || start >= end) { alert("Algunas fechas seleccionadas no están disponibles."); document.getElementById('end-date').value = ""; return; }

                const days = Math.max(1, Math.ceil((end - start) / 86400000));
                const subtotal = days * currentPrice;
                const fee = subtotal * 0.10; // 10% fee
                const total = subtotal + fee;

                const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                document.getElementById('summ-days').innerText = days;
                document.getElementById('summ-price').innerText = fmt.format(currentPrice);
                document.getElementById('summ-subtotal').innerText = fmt.format(subtotal);
                document.getElementById('summ-fee').innerText = fmt.format(fee);
                document.getElementById('summ-total').innerText = fmt.format(total);
                document.getElementById('summary').classList.remove('hidden');
            }
        }

        async function handleBooking() {
            if (!currentUser) { location.href = 'login.html'; return; }
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            if(!start || !end) return alert("Por favor selecciona fechas de entrada y salida.");

            const days = Math.max(1, Math.ceil((new Date(end) - new Date(start)) / 86400000));
            const total = parseFloat(((days * currentPrice) * 1.10).toFixed(2));

            const { error } = await pageDb.from('bookings').insert({
                space_id: spaceId, renter_id: currentUser.id, owner_id: ownerId,
                start_date: start, end_date: end, total_price: total, status: 'pending'
            });

            if(error) alert("Error: " + error.message);
            else { 
                alert("¡Solicitud enviada con éxito! El dueño confirmará pronto."); 
                location.href = 'dashboard.html'; 
            }
        }

        async function contactOwner() {
            if (!currentUser) { location.href = 'login.html'; return; }
            const msg = document.getElementById('contact-msg').value;
            if(!msg) return alert("Escribe un mensaje para el dueño.");

            const { error } = await pageDb.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: ownerId,
                space_id: spaceId,
                content: msg
            });

            if(error) alert("Error: " + error.message);
            else { 
                alert("Mensaje enviado. Revisa tu Dashboard."); 
                document.getElementById('contact-msg').value = '';
                location.href = 'dashboard.html';
            }
        }
    </script>
</body>
</html>