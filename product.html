<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle - Renty Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_green.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { black: '#0F0F0F', gray50: '#F9FAFB' },
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], serif: ['"Playfair Display"', 'serif'] },
                    boxShadow: { 'card': '0 12px 40px -8px rgba(0,0,0,0.1)' }
                }
            }
        }
    </script>
</head>
<body class="bg-white text-black font-sans antialiased">

    <nav class="border-b border-gray-100 p-4 sticky top-0 bg-white/90 backdrop-blur z-50 h-20">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 group">
                <i class="fa-solid fa-arrow-left text-lg group-hover:-translate-x-1 transition"></i>
                <span class="font-bold text-sm tracking-wide">Volver</span>
            </a>
            <div id="nav-right"></div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-12 max-w-7xl">
        <div id="loader" class="text-center py-40"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-gray-200"></i></div>

        <div id="product-content" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-12">
            
            <div class="lg:col-span-8 space-y-10">
                <div class="h-[500px] w-full rounded-3xl overflow-hidden shadow-sm relative bg-gray-100">
                    <img id="p-image" src="" class="w-full h-full object-cover">
                    <div class="absolute top-4 left-4 flex gap-2">
                        <span id="p-type" class="bg-white/90 backdrop-blur px-4 py-1.5 text-xs font-bold uppercase tracking-widest rounded-full shadow-sm"></span>
                    </div>
                </div>

                <div class="border-b border-gray-100 pb-8">
                    <h1 id="p-title" class="font-serif text-4xl md:text-5xl font-bold mb-4 text-black leading-tight"></h1>
                    <div class="flex items-center gap-4 text-gray-500 text-sm">
                        <span class="flex items-center gap-1"><i class="fa-solid fa-star text-black"></i> 4.9 (18 reseñas)</span>
                        <span>•</span>
                        <span id="p-location" class="underline decoration-gray-300 underline-offset-4"></span>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-bold text-xl font-serif">Acerca de este espacio</h3>
                    <p id="p-desc" class="text-gray-600 leading-8 text-lg font-light"></p>
                </div>

                <div class="pt-6">
                    <h3 class="font-bold text-xl font-serif mb-6">Ubicación</h3>
                    <div id="map" class="h-96 w-full rounded-2xl border border-gray-100 z-0"></div>
                </div>
            </div>

            <div class="lg:col-span-4 relative">
                <div class="sticky top-28 space-y-6">
                    
                    <div class="bg-white p-8 rounded-3xl shadow-card border border-gray-100">
                        <div class="flex justify-between items-end mb-6">
                            <div><span id="p-price" class="text-3xl font-bold font-serif text-black"></span> <span class="text-gray-400 font-light">/ noche</span></div>
                        </div>

                        <div class="border border-gray-200 rounded-xl overflow-hidden mb-4">
                            <div class="grid grid-cols-2 border-b border-gray-200">
                                <div class="p-3 border-r border-gray-200 bg-gray-50/50 hover:bg-gray-50 transition cursor-pointer relative">
                                    <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Entrada</label>
                                    <input id="start-date" class="w-full bg-transparent outline-none font-bold text-sm cursor-pointer" placeholder="Agrega fecha">
                                </div>
                                <div class="p-3 bg-gray-50/50 hover:bg-gray-50 transition cursor-pointer relative">
                                    <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Salida</label>
                                    <input id="end-date" class="w-full bg-transparent outline-none font-bold text-sm cursor-pointer" placeholder="Agrega fecha" disabled>
                                </div>
                            </div>
                        </div>

                        <button onclick="handleBooking()" class="w-full bg-black text-white py-4 rounded-xl font-bold hover:scale-[1.02] transition shadow-lg text-sm uppercase tracking-widest">
                            Reservar Ahora
                        </button>
                        
                        <div id="summary" class="hidden mt-6 pt-6 border-t border-gray-100 space-y-3 text-sm text-gray-600">
                            <div class="flex justify-between"><span>$ <span id="summ-price">0</span> x <span id="summ-days">0</span> noches</span><span>$<span id="summ-subtotal">0</span></span></div>
                            <div class="flex justify-between"><span>Tarifa servicio Renty</span><span>$<span id="summ-fee">0</span></span></div>
                            <div class="flex justify-between font-bold text-black text-lg pt-2 border-t border-gray-100 mt-2"><span>Total</span><span>$<span id="summ-total">0</span></span></div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100">
                        <h4 class="font-bold text-sm mb-3 text-gray-800">¿Tienes dudas?</h4>
                        <textarea id="contact-msg" class="w-full bg-white border border-gray-200 p-3 rounded-xl text-sm mb-3 outline-none focus:border-black resize-none" rows="3" placeholder="Hola, me interesa saber..."></textarea>
                        <button onclick="contactOwner()" class="w-full bg-white border border-black text-black py-2.5 rounded-xl font-bold hover:bg-gray-100 transition text-xs uppercase tracking-wide">Contactar al Dueño</button>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script src="assets/js/app.js"></script>
    <script>
        // LÓGICA DE PRODUCTO (Idéntica a la anterior)
        const pageDb = supabase.createClient('https://pmedrqauhesybkzxraxd.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtZWRycWF1aGVzeWJrenhyYXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTQyNTIsImV4cCI6MjA4NTk5MDI1Mn0.DnC8YSij2mN-gR3kcnYzjhVmy1HXKcul_TcXzAjcI-I');
        let currentPrice = 0, ownerId = null, spaceId = null, disabledDates = [];
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search); spaceId = params.get('id'); if(!spaceId) location.href = 'index.html';
            await loadSpaceDetails();
        });
        async function loadSpaceDetails() {
            const { data: space, error } = await pageDb.from('spaces').select('*, bookings(*)').eq('id', spaceId).single();
            if (error || !space) { alert("No encontrado"); location.href = 'index.html'; return; }
            if (space.bookings) space.bookings.forEach(b => { if (b.status === 'approved' || b.status === 'blocked') disabledDates.push({ from: b.start_date, to: b.end_date }); });
            
            document.getElementById('p-title').innerText = space.title; document.getElementById('p-location').innerText = space.location;
            document.getElementById('p-desc').innerText = space.description; document.getElementById('p-type').innerText = space.type;
            document.getElementById('p-image').src = space.image; document.getElementById('p-price').innerText = '$' + new Intl.NumberFormat('es-AR').format(space.price);
            currentPrice = space.price; ownerId = space.owner_id;
            
            document.getElementById('loader').classList.add('hidden'); document.getElementById('product-content').classList.remove('hidden');
            
            if (space.lat && space.lng) { setTimeout(() => { const map = L.map('map').setView([space.lat, space.lng], 15); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map); L.marker([space.lat, space.lng]).addTo(map).bindPopup(space.title).openPopup(); map.invalidateSize(); }, 300); } 
            else document.getElementById('map').innerHTML = '<div class="h-full flex items-center justify-center bg-gray-50 text-gray-400 rounded-2xl">Sin mapa</div>';
            
            const ep = flatpickr("#end-date", { locale: "es", dateFormat: "Y-m-d", minDate: "today", disable: disabledDates });
            flatpickr("#start-date", { locale: "es", dateFormat: "Y-m-d", minDate: "today", disable: disabledDates, onChange: (d, s) => { ep.set('minDate', s); document.getElementById('end-date').disabled = false; setTimeout(() => ep.open(), 100); } });
            document.getElementById('end-date').addEventListener('change', calcTotal);
        }
        function calcTotal() {
            const s = new Date(document.getElementById('start-date').value); const e = new Date(document.getElementById('end-date').value);
            let v = true; disabledDates.forEach(d => { if (new Date(d.from) >= s && new Date(d.to) <= e) v = false; });
            if (!v || s >= e) { alert("Fechas no disponibles."); document.getElementById('end-date').value = ""; return; }
            const days = Math.max(1, Math.ceil((e - s) / 86400000));
            const sub = days * currentPrice; const fee = sub * 0.10; const tot = sub + fee;
            const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2 });
            document.getElementById('summ-days').innerText = days; document.getElementById('summ-price').innerText = fmt.format(currentPrice);
            document.getElementById('summ-subtotal').innerText = fmt.format(sub); document.getElementById('summ-fee').innerText = fmt.format(fee);
            document.getElementById('summ-total').innerText = fmt.format(tot); document.getElementById('summary').classList.remove('hidden');
        }
        async function handleBooking() {
            if (!currentUser) { location.href = 'login.html'; return; }
            const s = document.getElementById('start-date').value; const e = document.getElementById('end-date').value;
            if(!s || !e) return alert("Selecciona fechas");
            const days = Math.max(1, Math.ceil((new Date(e) - new Date(s)) / 86400000)); const total = parseFloat(((days * currentPrice) * 1.10).toFixed(2));
            const { error } = await pageDb.from('bookings').insert({ space_id: spaceId, renter_id: currentUser.id, owner_id: ownerId, start_date: s, end_date: e, total_price: total, status: 'pending' });
            if(error) alert(error.message); else { alert("¡Solicitud enviada!"); location.href = 'dashboard.html'; }
        }
        async function contactOwner() {
            if (!currentUser) { location.href = 'login.html'; return; }
            const msg = document.getElementById('contact-msg').value; if(!msg) return alert("Escribe un mensaje");
            const { error } = await pageDb.from('messages').insert({ sender_id: currentUser.id, receiver_id: ownerId, space_id: spaceId, content: msg });
            if(error) alert(error.message); else { alert("Mensaje enviado"); location.href = 'dashboard.html'; }
        }
    </script>
</body>
</html>