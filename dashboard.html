<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel - Renty Club</title>
    
    <link rel="stylesheet" href="assets/css/styles.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/config.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-bg text-brand font-sans antialiased h-screen flex overflow-hidden">

    <aside class="w-64 bg-surface border-r border-border flex flex-col justify-between hidden md:flex shrink-0 z-20">
        <div>
            <div class="h-20 flex items-center px-8">
                <a href="index.html" class="flex items-center gap-2 group">
                    <div class="w-8 h-8 bg-brand text-white flex items-center justify-center font-serif text-lg italic rounded-md">R</div>
                    <span class="text-xl font-bold tracking-tight">RentyClub</span>
                </a>
            </div>
            
            <nav class="p-4 space-y-1 mt-2">
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Menu Principal</p>
                <button onclick="switchTab('hosting')" id="btn-hosting" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 text-gray-600 hover:bg-gray-50">
                    <i class="fa-solid fa-store w-5 text-center"></i> Mis Espacios
                </button>
                <button onclick="switchTab('rentals')" id="btn-rentals" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 text-gray-600 hover:bg-gray-50">
                    <i class="fa-regular fa-calendar-check w-5 text-center"></i> Mis Reservas
                </button>
                <button onclick="switchTab('messages')" id="btn-messages" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 text-gray-600 hover:bg-gray-50">
                    <i class="fa-regular fa-comment-dots w-5 text-center"></i> Mensajes
                </button>

                <div id="admin-menu" class="hidden mt-8 pt-4 border-t border-border">
                    <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Admin</p>
                    <button onclick="switchTab('admin')" id="btn-admin" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl text-red-600 hover:bg-red-50 transition-all">
                        <i class="fa-solid fa-shield-halved w-5 text-center"></i> Panel Maestro
                    </button>
                </div>
            </nav>
        </div>

        <div class="p-6 border-t border-border">
            <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-gray-500 hover:text-red-600 transition-colors">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar SesiÃ³n
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 md:p-12 relative bg-bg rc-scroll">
        
        <div class="md:hidden flex justify-between items-center mb-8">
            <a href="index.html" class="font-bold text-xl">RentyClub</a>
            <button onclick="handleLogout()" class="text-xs font-bold text-red-500 bg-red-50 px-3 py-1 rounded-full">Salir</button>
        </div>

        <div id="view-hosting" class="view-section">
            <div class="flex justify-between items-end mb-10">
                <div>
                    <h1 class="text-3xl font-bold text-brand">Hola, <span id="user-name-display">Usuario</span> ðŸ‘‹</h1>
                    <p class="text-secondary text-sm mt-2">Gestiona tus publicaciones y ganancias.</p>
                </div>
                <a href="create.html" class="bg-brand text-white px-6 py-3 rounded-lg text-sm font-bold hover:bg-gray-800 transition shadow-lg flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Publicar nuevo espacio
                </a>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div class="bg-surface p-6 rounded-2xl border border-border shadow-card flex flex-col justify-between h-32">
                    <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center text-lg mb-2"><i class="fa-regular fa-building"></i></div>
                    <div><p class="text-2xl font-bold text-brand" id="kpi-active-spaces">-</p><p class="text-xs text-gray-400 font-medium">Espacios activos</p></div>
                </div>
                <div class="bg-surface p-6 rounded-2xl border border-border shadow-card flex flex-col justify-between h-32">
                    <div class="w-10 h-10 bg-green-50 text-green-600 rounded-lg flex items-center justify-center text-lg mb-2"><i class="fa-solid fa-dollar-sign"></i></div>
                    <div><p class="text-2xl font-bold text-brand">$0</p><p class="text-xs text-gray-400 font-medium">Ingresos totales</p></div>
                </div>
                <div class="bg-surface p-6 rounded-2xl border border-border shadow-card flex flex-col justify-between h-32">
                    <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-lg flex items-center justify-center text-lg mb-2"><i class="fa-regular fa-eye"></i></div>
                    <div><p class="text-2xl font-bold text-brand">0</p><p class="text-xs text-gray-400 font-medium">Vistas totales</p></div>
                </div>
                <div class="bg-surface p-6 rounded-2xl border border-border shadow-card flex flex-col justify-between h-32">
                    <div class="w-10 h-10 bg-orange-50 text-orange-600 rounded-lg flex items-center justify-center text-lg mb-2"><i class="fa-regular fa-calendar"></i></div>
                    <div><p class="text-2xl font-bold text-brand" id="kpi-pending-reqs">-</p><p class="text-xs text-gray-400 font-medium">Solicitudes pendientes</p></div>
                </div>
            </div>

            <div class="space-y-12">
                <div>
                    <h3 class="font-bold text-lg mb-6">Solicitudes Recientes</h3>
                    <div id="requests-list" class="space-y-4"></div>
                </div>

                <div>
                    <h3 class="font-bold text-lg mb-6">Mis Espacios</h3>
                    <div id="my-spaces-list" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <div id="view-rentals" class="view-section hidden">
            <h1 class="text-3xl font-bold mb-2 text-brand">Mis reservas</h1>
            <div class="flex gap-4 mb-8 border-b border-border pb-1">
                <button class="px-4 py-2 border-b-2 border-brand font-bold text-brand text-sm">Mis solicitudes</button>
            </div>
            <div id="rentals-list" class="space-y-4 max-w-4xl"></div>
        </div>

        <div id="view-messages" class="view-section hidden h-full">
            <div class="grid grid-cols-12 h-full bg-surface rounded-2xl border border-border shadow-card overflow-hidden">
                <div class="col-span-4 border-r border-border flex flex-col">
                    <div class="p-6 border-b border-border">
                        <h2 class="font-bold text-xl mb-4">Mensajes</h2>
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                            <input class="w-full bg-gray-50 border border-gray-100 rounded-lg py-2.5 pl-9 pr-4 text-xs font-medium focus:outline-none focus:ring-1 focus:ring-black" placeholder="Buscar...">
                        </div>
                    </div>
                    <div id="threads-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                </div>
                
                <div class="col-span-8 bg-gray-50 flex flex-col items-center justify-center text-center p-10" id="chat-empty-state">
                    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center text-gray-400 mb-4 text-2xl"><i class="fa-regular fa-comments"></i></div>
                    <h3 class="font-bold text-lg text-gray-700">SeleccionÃ¡ una conversaciÃ³n</h3>
                </div>

                <div class="col-span-8 flex flex-col hidden h-full" id="chat-active-view">
                    <div class="p-4 border-b border-border bg-white flex justify-between items-center shadow-sm z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-black text-white rounded-full flex items-center justify-center"><i class="fa-solid fa-user"></i></div>
                            <div><h3 class="font-bold text-sm" id="chat-header">User</h3><p class="text-xs text-gray-500" id="chat-subheader">Space</p></div>
                        </div>
                        <button onclick="closeChat()" class="text-gray-400 hover:text-black md:hidden"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="chat-body" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50"></div>
                    <div class="p-4 bg-white border-t border-border flex gap-2">
                        <input type="hidden" id="chat-to"><input type="hidden" id="chat-space">
                        <input id="chat-input" class="flex-1 bg-gray-50 border border-gray-200 rounded-full px-5 py-3 text-sm focus:outline-none focus:border-black" placeholder="Escribe..." onkeypress="if(event.key==='Enter') sendMsg()">
                        <button onclick="sendMsg()" class="w-12 h-12 bg-black text-white rounded-full flex items-center justify-center hover:scale-105 transition shadow-lg"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view-section hidden">
            <div class="bg-surface p-8 rounded-2xl border border-border shadow-card">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold tracking-tight text-red-600">Super Admin</h2>
                    <button onclick="loadAdminData()" class="text-xs font-bold bg-white border border-gray-200 px-4 py-2 rounded-lg hover:bg-gray-50 transition">Refrescar Datos</button>
                </div>
                
                <div class="grid grid-cols-3 gap-6 mb-12">
                    <div class="bg-black text-white p-6 rounded-2xl shadow-lg"><p class="text-xs font-bold opacity-60 mb-1 uppercase tracking-wide">Usuarios</p><p id="kpi-users" class="text-4xl font-bold">0</p></div>
                    <div class="bg-white border border-border p-6 rounded-2xl shadow-sm"><p class="text-xs font-bold text-gray-400 mb-1 uppercase tracking-wide">Propiedades</p><p id="kpi-spaces" class="text-4xl font-bold">0</p></div>
                    <div class="bg-white border border-border p-6 rounded-2xl shadow-sm"><p class="text-xs font-bold text-gray-400 mb-1 uppercase tracking-wide">Reservas</p><p id="kpi-bookings" class="text-4xl font-bold">0</p></div>
                </div>

                <div class="space-y-12">
                    <div>
                        <div class="flex justify-between items-end mb-4">
                            <h3 class="font-bold text-sm uppercase tracking-wide text-gray-500">GestiÃ³n de Usuarios</h3>
                            <button onclick="document.getElementById('user-modal').classList.remove('hidden')" class="bg-black text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:opacity-80">+ Nuevo</button>
                        </div>
                        <div class="overflow-hidden border border-border rounded-xl">
                            <table class="min-w-full divide-y divide-border">
                                <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Email</th><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Rol</th><th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">AcciÃ³n</th></tr></thead>
                                <tbody id="admin-users-list" class="bg-white divide-y divide-border"></tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-sm uppercase tracking-wide text-gray-500 mb-4">Todas las Propiedades</h3>
                        <div class="overflow-hidden border border-border rounded-xl">
                            <div class="max-h-96 overflow-y-auto">
                                <table class="min-w-full divide-y divide-border">
                                    <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Propiedad</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">DueÃ±o ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Precio</th>
                                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">AcciÃ³n</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-spaces-list" class="bg-white divide-y divide-border"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-sm uppercase tracking-wide text-gray-500 mb-4">Todas las Reservas</h3>
                        <div class="overflow-hidden border border-border rounded-xl">
                            <div class="max-h-96 overflow-y-auto">
                                <table class="min-w-full divide-y divide-border">
                                    <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Propiedad</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Fechas</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Estado</th>
                                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">AcciÃ³n</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-bookings-list" class="bg-white divide-y divide-border"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="edit-space-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl max-w-2xl w-full shadow-2xl border border-gray-100 overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold mb-6">Editar Propiedad</h3>
            <input type="hidden" id="edit-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">TÃ­tulo</label><input id="edit-title" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-black"></div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Precio / dÃ­a</label><input id="edit-price" type="number" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-black"></div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">TamaÃ±o (mÂ²)</label><input id="edit-size" type="number" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-black" placeholder="Opcional"></div>
                <div class="md:col-span-2"><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Imagen URL</label><input id="edit-image" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-black"></div>
                <div class="md:col-span-2">
                    <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">UbicaciÃ³n</label>
                    <div class="flex gap-2 mb-2"><input id="edit-location" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-black"><button onclick="searchEditMap()" class="bg-black text-white px-4 rounded-lg text-xs font-bold hover:opacity-80">Buscar</button></div>
                    <div id="edit-map" class="border border-gray-200"></div><input type="hidden" id="edit-lat"><input type="hidden" id="edit-lng">
                </div>
            </div>
            <div class="mb-8"><label class="text-[10px] font-bold uppercase text-gray-400 block mb-3">Amenities</label><div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="edit-amenities-container"></div></div>
            <div class="flex gap-3"><button onclick="document.getElementById('edit-space-modal').classList.add('hidden')" class="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-black">Cancelar</button><button onclick="saveSpaceEdit()" class="flex-1 py-3 bg-black text-white text-sm font-bold rounded-lg hover:bg-gray-800">Guardar Cambios</button></div>
        </div>
    </div>
    <div id="user-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-bold mb-6">Nuevo Usuario</h3>
            <input id="new-user-email" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm mb-3 outline-none" placeholder="Email">
            <input id="new-user-pass" type="password" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm mb-6 outline-none" placeholder="ContraseÃ±a">
            <div class="flex gap-3"><button onclick="document.getElementById('user-modal').classList.add('hidden')" class="flex-1 py-3 text-sm font-bold text-gray-500">Cancelar</button><button onclick="createNewUser()" class="flex-1 py-3 bg-black text-white text-sm font-bold rounded-lg">Crear</button></div>
        </div>
    </div>
    <div id="block-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-bold mb-2">Bloquear Fechas</h3>
            <p class="text-xs text-gray-500 mb-6">Selecciona el rango no disponible.</p>
            <input type="hidden" id="block-space-id">
            <input id="block-dates" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm mb-6 text-center font-bold outline-none" placeholder="Seleccionar fechas">
            <div class="flex gap-3"><button onclick="document.getElementById('block-modal').classList.add('hidden')" class="flex-1 py-3 text-sm font-bold text-gray-500">Cancelar</button><button onclick="confirmBlock()" class="flex-1 py-3 bg-black text-white text-sm font-bold rounded-lg">Confirmar</button></div>
        </div>
    </div>

    <script src="assets/js/app.js"></script>
    <script>
        const adminDb = supabase.createClient('https://pmedrqauhesybkzxraxd.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtZWRycWF1aGVzeWJrenhyYXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTQyNTIsImV4cCI6MjA4NTk5MDI1Mn0.DnC8YSij2mN-gR3kcnYzjhVmy1HXKcul_TcXzAjcI-I');
        let currentUserId = null;
        const AMENITIES_LIST = ["Seguridad 24hs", "CalefacciÃ³n", "BaÃ±o privado", "Cocina", "Cochera", "Vidriera", "Aire Acondicionado", "WiFi"];
        let editMap, editMarker;

        document.addEventListener('DOMContentLoaded', async () => {
            setTimeout(async () => {
                const { data: { session } } = await adminDb.auth.getSession();
                if (!session) { location.href = 'login.html'; return; }
                currentUserId = session.user.id;
                
                const { data: profile } = await adminDb.from('profiles').select('*').eq('id', currentUserId).single();
                if (profile) {
                    if (profile.full_name) document.getElementById('user-name-display').innerText = profile.full_name.split(' ')[0];
                    if (profile.role === 'super_admin') { 
                        document.getElementById('admin-menu').classList.remove('hidden'); 
                        loadAdminData();
                    }
                }
                loadHostingData(); loadMyRentals(); loadMessages(); switchTab('hosting');
            }, 300);
        });

        function switchTab(t) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden'));
            document.getElementById('view-'+t).classList.remove('hidden');
            document.querySelectorAll('aside nav button').forEach(b=>{ b.classList.remove('bg-gray-100', 'text-black', 'font-bold'); b.classList.add('text-gray-600', 'hover:bg-gray-50'); });
            const btn = document.getElementById('btn-'+t); if(btn) { btn.classList.add('bg-gray-100', 'text-black', 'font-bold'); btn.classList.remove('text-gray-600', 'hover:bg-gray-50'); }
            if(t === 'messages') loadMessages();
            if(t === 'admin') loadAdminData();
        }

        async function loadHostingData() {
            const { data: requests } = await adminDb.from('bookings').select('*, spaces(title, image)').eq('owner_id', currentUserId).neq('status', 'blocked').order('created_at', {ascending:false});
            const list = document.getElementById('requests-list');
            const pendingCount = requests?.filter(r => r.status === 'pending').length || 0;
            document.getElementById('kpi-pending-reqs').innerText = pendingCount;

            list.innerHTML = (!requests || requests.length === 0) ? `<div class="bg-surface p-8 rounded-2xl border border-border text-center"><i class="fa-regular fa-envelope-open text-3xl text-gray-300 mb-3"></i><p class="text-sm text-gray-500 font-medium">No tienes solicitudes pendientes.</p></div>` : '';
            
            requests?.forEach(r => {
                const title = r.spaces?.title || 'Propiedad eliminada';
                const img = r.spaces?.image || 'https://via.placeholder.com/100';
                let badgeClass = r.status==='pending'?'badge-pending':(r.status==='approved'?'badge-approved':'badge-rejected');
                let btns = r.status==='pending' ? `<div class="flex gap-2"><button onclick="updateStatus(${r.id},'approved')" class="bg-black text-white px-4 py-2 rounded-lg text-xs font-bold hover:scale-105 transition">Aprobar</button><button onclick="updateStatus(${r.id},'rejected')" class="border border-gray-200 text-gray-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-gray-50 transition">Rechazar</button></div>` : '';
                if(r.status === 'approved') btns = `<button onclick="cancelBooking(${r.id})" class="text-red-500 text-xs font-bold hover:underline">Cancelar</button>`;

                list.innerHTML += `<div class="bg-surface p-5 rounded-2xl border border-border shadow-card flex flex-col md:flex-row items-center justify-between gap-4"><div class="flex items-center gap-4"><img src="${img}" class="w-14 h-14 rounded-lg object-cover bg-gray-100 border border-gray-100"><div><div class="flex items-center gap-2 mb-1"><h4 class="font-bold text-sm text-brand">${title}</h4><span class="${badgeClass} px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">${r.status}</span></div><p class="text-xs text-gray-500 font-medium"><i class="fa-regular fa-calendar mr-1"></i> ${r.start_date} â€” ${r.end_date}</p></div></div><div>${btns}</div></div>`;
            });

            const { data: spaces } = await adminDb.from('spaces').select('*').eq('owner_id', currentUserId);
            const { data: blocks } = await adminDb.from('bookings').select('*').eq('owner_id', currentUserId).eq('status', 'blocked');
            const sList = document.getElementById('my-spaces-list');
            document.getElementById('kpi-active-spaces').innerText = spaces?.length || 0;

            sList.innerHTML = (!spaces || spaces.length === 0) ? `<div class="bg-surface py-16 rounded-2xl border border-border text-center flex flex-col items-center justify-center"><div class="w-12 h-12 bg-gray-50 rounded-full flex items-center justify-center text-gray-400 mb-4 text-xl"><i class="fa-regular fa-building"></i></div><h3 class="font-bold text-brand text-lg mb-1">No tenÃ©s espacios publicados</h3><p class="text-gray-500 text-sm mb-6">EmpezÃ¡ a ganar dinero publicando tu primer espacio</p><a href="create.html" class="bg-black text-white px-6 py-3 rounded-lg text-sm font-bold shadow-lg hover:scale-105 transition">Publicar mi primer espacio</a></div>` : '';
            
            spaces?.forEach(s => {
                const sBlocks = blocks?.filter(b => b.space_id === s.id) || [];
                let bHtml = sBlocks.map(sb => `<span class="bg-gray-50 border border-gray-100 text-[10px] px-2 py-1 rounded flex items-center gap-2 text-gray-500 font-medium">${sb.start_date} <button onclick="deleteBlock(${sb.id})" class="text-red-400 hover:text-red-600 ml-1">Ã—</button></span>`).join('');
                sList.innerHTML += `<div class="bg-surface p-5 rounded-2xl border border-border shadow-card hover:shadow-hover transition"><div class="flex gap-5"><img src="${s.image||'https://via.placeholder.com/150'}" class="w-20 h-20 rounded-xl object-cover bg-gray-100 border border-gray-100"><div class="flex-1 flex flex-col justify-center"><h4 class="font-bold text-base text-brand mb-1">${s.title||'Sin TÃ­tulo'}</h4><p class="text-xs text-gray-500 mb-2"><i class="fa-solid fa-location-dot mr-1"></i> ${s.location||'Sin ubicaciÃ³n'}</p><div class="flex gap-2"><button onclick="openEditSpace('${s.id}')" class="text-xs font-bold text-black bg-gray-100 px-3 py-1.5 rounded-md hover:bg-gray-200">Editar</button><button onclick="openBlockModal(${s.id})" class="text-xs font-bold text-gray-500 border border-gray-200 px-3 py-1.5 rounded-md hover:text-black">Bloquear</button><button onclick="deleteSpace(${s.id})" class="text-xs font-bold text-red-400 hover:text-red-600 px-2 py-1.5">Eliminar</button></div></div></div>${bHtml ? `<div class="mt-4 pt-4 border-t border-gray-50 flex flex-wrap gap-2">${bHtml}</div>` : ''}</div>`;
            });
        }

        async function openEditSpace(id) {
            const { data: s } = await adminDb.from('spaces').select('*').eq('id', id).single();
            if(s) {
                document.getElementById('edit-id').value = s.id;
                document.getElementById('edit-title').value = s.title;
                document.getElementById('edit-price').value = s.price;
                document.getElementById('edit-size').value = s.size || '';
                document.getElementById('edit-location').value = s.location;
                document.getElementById('edit-image').value = s.image;
                
                const container = document.getElementById('edit-amenities-container'); container.innerHTML = '';
                const currentAm = s.amenities || [];
                AMENITIES_LIST.forEach(am => {
                    const checked = currentAm.includes(am) ? 'checked' : '';
                    container.innerHTML += `<label class="flex items-center gap-2 text-xs font-medium cursor-pointer"><input type="checkbox" value="${am}" ${checked} class="accent-black w-4 h-4 rounded"> ${am}</label>`;
                });
                
                document.getElementById('edit-space-modal').classList.remove('hidden');
                setTimeout(() => {
                    if (!editMap) {
                        editMap = L.map('edit-map').setView([-34.6037, -58.3816], 13);
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(editMap);
                        editMap.on('click', (e) => { if (editMarker) editMap.removeLayer(editMarker); editMarker = L.marker(e.latlng).addTo(editMap); });
                    }
                    editMap.invalidateSize(); searchEditMap(true);
                }, 200);
            }
        }
        async function searchEditMap(isInit = false) {
            const query = document.getElementById('edit-location').value; if(!query) return;
            try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`); const data = await res.json(); if(data && data.length > 0) { const lat = data[0].lat; const lon = data[0].lon; if(editMap) { editMap.setView([lat, lon], 16); if(editMarker) editMap.removeLayer(editMarker); editMarker = L.marker([lat, lon]).addTo(editMap).bindPopup(query).openPopup(); } } } catch(e) { console.error(e); }
        }
        async function saveSpaceEdit() {
            const id = document.getElementById('edit-id').value;
            const am = Array.from(document.querySelectorAll('#edit-amenities-container input:checked')).map(cb=>cb.value);
            const updates = { title: document.getElementById('edit-title').value, price: document.getElementById('edit-price').value, size: document.getElementById('edit-size').value || null, location: document.getElementById('edit-location').value, image: document.getElementById('edit-image').value, amenities: am };
            await adminDb.from('spaces').update(updates).eq('id', id);
            document.getElementById('edit-space-modal').classList.add('hidden'); loadHostingData(); if(!document.getElementById('view-admin').classList.contains('hidden')) loadAdminData();
        }

        async function loadMyRentals() {
            const { data: bookings } = await adminDb.from('bookings').select('*, spaces(title, location, image)').eq('renter_id', currentUserId).neq('status', 'blocked').order('created_at', {ascending:false});
            const list = document.getElementById('rentals-list');
            list.innerHTML = (!bookings || bookings.length === 0) ? `<p class="text-gray-400 text-sm italic">No tienes reservas activas.</p>` : '';
            bookings?.forEach(b => {
                const title = b.spaces?.title || 'Propiedad eliminada'; const loc = b.spaces?.location || ''; const img = b.spaces?.image || 'https://via.placeholder.com/150';
                const price = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumSignificantDigits: 3 }).format(b.total_price);
                let badgeClass = b.status==='pending'?'badge-pending':(b.status==='approved'?'badge-approved':'badge-rejected');
                list.innerHTML += `<div class="bg-surface rounded-xl border border-border shadow-card p-4 flex gap-5 items-center transition hover:shadow-hover"><img src="${img}" class="w-32 h-24 rounded-lg object-cover bg-gray-100"><div class="flex-1"><div class="flex justify-between items-start mb-1"><h4 class="font-bold text-brand text-lg">${title}</h4><span class="${badgeClass} px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${b.status}</span></div><p class="text-xs text-gray-500 mb-3"><i class="fa-solid fa-location-dot mr-1"></i> ${loc}</p><div class="flex items-center gap-4 text-sm font-medium text-gray-700"><span class="flex items-center gap-2"><i class="fa-regular fa-calendar"></i> ${b.start_date} - ${b.end_date}</span><span class="font-bold text-black">${price}</span></div>${(b.status==='pending'||b.status==='approved') ? `<button onclick="cancelBooking(${b.id})" class="text-red-400 text-xs font-bold hover:underline mt-2">Cancelar solicitud</button>` : ''}</div></div>`;
            });
        }
        
        async function loadMessages() {
            const { data: msgs } = await adminDb.from('messages').select('*, sender:profiles!messages_sender_id_fkey(email), receiver:profiles!messages_receiver_id_fkey(email), spaces(title, image)').or(`sender_id.eq.${currentUserId},receiver_id.eq.${currentUserId}`).order('created_at', {ascending: true});
            const listDiv = document.getElementById('threads-list');
            
            // Si no hay mensajes
            if (!msgs || msgs.length === 0) {
                listDiv.innerHTML = '<div class="text-center py-10 opacity-50"><p class="text-xs">No hay mensajes</p></div>';
                return;
            }

            // Agrupar mensajes por conversaciÃ³n (hilo)
            const threads = {};
            msgs.forEach(m => {
                const isMe = m.sender_id === currentUserId;
                const otherId = isMe ? m.receiver_id : m.sender_id;
                const otherEmail = isMe ? (m.receiver?.email || 'Usuario') : (m.sender?.email || 'Usuario'); 
                const spaceTitle = m.spaces?.title || 'Consulta'; 
                const spaceImg = m.spaces?.image || 'https://via.placeholder.com/100';
                
                // Clave Ãºnica por Espacio + Usuario
                const key = `${m.space_id}-${otherId}`;
                
                if (!threads[key]) {
                    threads[key] = { otherId, otherEmail, spaceTitle, spaceId: m.space_id, spaceImg, msgs: [] };
                }
                threads[key].msgs.push(m);
            });

            // Dibujar la lista de hilos
            listDiv.innerHTML = '';
            Object.values(threads).forEach(t => {
                const last = t.msgs[t.msgs.length - 1]; 
                const time = new Date(last.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                // Importante: openChat usa JSON.stringify, aseguramos que las comillas no rompan el HTML
                const threadData = JSON.stringify(t).replace(/"/g, '&quot;');

                listDiv.innerHTML += `
                <div onclick='openChat(${JSON.stringify(t)})' class="p-3 rounded-xl hover:bg-gray-100 cursor-pointer transition flex items-start gap-3 group border-b border-gray-50 last:border-0">
                    <img src="${t.spaceImg}" class="w-10 h-10 rounded-lg object-cover bg-gray-100 border border-gray-200">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-0.5">
                            <h4 class="font-bold text-xs text-brand truncate max-w-[120px]">${t.spaceTitle}</h4>
                            <span class="text-[10px] text-gray-400 font-medium">${time}</span>
                        </div>
                        <p class="text-[10px] text-gray-500 mb-0.5 flex items-center gap-1">
                            <i class="fa-solid fa-user text-[8px]"></i> ${t.otherEmail}
                        </p>
                        <p class="text-xs text-gray-600 truncate opacity-80 group-hover:opacity-100 font-medium">
                            ${last.content}
                        </p>
                    </div>
                </div>`;
            });
        }
        
        function openChat(t) {
            document.getElementById('chat-empty-state').classList.add('hidden'); 
            document.getElementById('chat-active-view').classList.remove('hidden');
            
            document.getElementById('chat-header').innerText = t.otherEmail; 
            document.getElementById('chat-subheader').innerText = t.spaceTitle; 
            document.getElementById('chat-to').value = t.otherId; 
            document.getElementById('chat-space').value = t.spaceId;
            
            const b = document.getElementById('chat-body'); 
            b.innerHTML = '';
            
            t.msgs.forEach(m => { 
                const isMe = m.sender_id === currentUserId; 
                b.innerHTML += `
                <div class="flex flex-col ${isMe?'items-end':'items-start'} w-full animate-fade-in-up">
                    <div class="${isMe?'bg-black text-white rounded-br-none':'bg-white text-black border border-gray-200 rounded-bl-none'} px-5 py-3 rounded-2xl max-w-[85%] text-sm shadow-sm">
                        ${m.content}
                    </div>
                    <span class="text-[10px] text-gray-400 mt-1 px-1">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                </div>`; 
            }); 
            
            setTimeout(() => b.scrollTop = b.scrollHeight, 100);
        }
        
        function closeChat() { 
            document.getElementById('chat-active-view').classList.add('hidden'); 
            document.getElementById('chat-empty-state').classList.remove('hidden'); 
        }

        async function loadAdminData() {
            const { count: u } = await adminDb.from('profiles').select('*', { count: 'exact', head: true });
            const { count: s } = await adminDb.from('spaces').select('*', { count: 'exact', head: true });
            const { count: b } = await adminDb.from('bookings').select('*', { count: 'exact', head: true });
            document.getElementById('kpi-users').innerText = u || 0; document.getElementById('kpi-spaces').innerText = s || 0; document.getElementById('kpi-bookings').innerText = b || 0;

            const { data: users } = await adminDb.from('profiles').select('*').order('created_at', {ascending: false});
            const uTable = document.getElementById('admin-users-list'); uTable.innerHTML = '';
            users?.forEach(u => { uTable.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-50 last:border-0"><td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${u.email}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><select onchange="changeUserRole('${u.id}', this.value)" class="bg-white border border-gray-200 text-xs rounded-lg p-1.5 outline-none focus:border-black cursor-pointer"><option value="user" ${u.role==='user'?'selected':''}>Usuario</option><option value="owner" ${u.role==='owner'?'selected':''}>DueÃ±o</option><option value="super_admin" ${u.role==='super_admin'?'selected':''}>Super Admin</option></select></td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onclick="adminDeleteUser('${u.id}')" class="text-red-400 hover:text-red-600 font-bold text-xs">Eliminar</button></td></tr>`; });

            const { data: spaces } = await adminDb.from('spaces').select('*').order('created_at', {ascending: false});
            const sTable = document.getElementById('admin-spaces-list'); sTable.innerHTML = '';
            spaces?.forEach(s => { 
                const owner = s.owner_id ? s.owner_id.substring(0,6) : 'N/A';
                sTable.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-50 last:border-0">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900"><div class="flex items-center gap-3"><img src="${s.image||'https://via.placeholder.com/150'}" class="w-8 h-8 rounded bg-gray-100 object-cover">${s.title}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${owner}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">$${s.price}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end gap-2">
                            <button onclick="openEditSpace('${s.id}')" class="text-blue-500 hover:text-blue-700 font-bold text-xs"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteSpace('${s.id}', true)" class="text-red-400 hover:text-red-600 font-bold text-xs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`; 
            });

            const { data: bookings } = await adminDb.from('bookings').select('*, spaces(title)').order('created_at', {ascending: false});
            const bTable = document.getElementById('admin-bookings-list'); bTable.innerHTML = '';
            
            bookings?.forEach(b => { 
                const title = b.spaces ? b.spaces.title : '<span class="text-red-400 italic">Eliminada</span>';
                let actions = '';
                
                if (b.status === 'pending') {
                    actions = `<button onclick="updateStatus(${b.id}, 'approved')" class="text-green-600 hover:text-green-800 font-bold text-xs mr-2">Aprobar</button>
                               <button onclick="updateStatus(${b.id}, 'rejected')" class="text-red-400 hover:text-red-600 font-bold text-xs">Rechazar</button>`;
                } else if (b.status === 'approved') {
                    actions = `<button onclick="updateStatus(${b.id}, 'cancelled')" class="text-red-400 hover:text-red-600 font-bold text-xs hover:underline">Cancelar</button>`;
                } else if (b.status === 'rejected') {
                    actions = `<button onclick="updateStatus(${b.id}, 'approved')" class="text-green-600 hover:text-green-800 font-bold text-xs">Re-Aprobar</button>`;
                } else {
                    actions = `<span class="text-gray-300 text-xs italic">-</span>`;
                }

                bTable.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-50 last:border-0">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${b.start_date} <span class="text-gray-300 mx-1">â†’</span> ${b.end_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 uppercase">${b.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end gap-2 items-center">
                            ${actions}
                        </div>
                    </td>
                </tr>`; 
            });
        }

        async function updateStatus(id, s) { await adminDb.from('bookings').update({status:s}).eq('id', id); loadHostingData(); if(!document.getElementById('view-admin').classList.contains('hidden')) loadAdminData(); }
        async function cancelBooking(id) { if(confirm("Â¿Cancelar?")) await adminDb.from('bookings').update({status:'cancelled'}).eq('id', id); location.reload(); }
        async function deleteBlock(id) { if(confirm("Â¿Liberar?")) await adminDb.from('bookings').delete().eq('id', id); loadHostingData(); }
        async function deleteSpace(id, isAdm=false) { if(confirm("Â¿Eliminar?")) await adminDb.from('spaces').delete().eq('id', id); isAdm ? loadAdminData() : location.reload(); }
        async function changeUserRole(id, role) { if(confirm(`Â¿Cambiar rol a ${role}?`)) await adminDb.from('profiles').update({role}).eq('id', id); loadAdminData(); }
        async function adminDeleteUser(id) { if(confirm("Â¿Borrar usuario?")) await adminDb.from('profiles').delete().eq('id', id); loadAdminData(); }
        async function handleLogout() { await adminDb.auth.signOut(); location.href = 'login.html'; }
        async function sendMsg() { 
            const val = document.getElementById('chat-input').value; if(!val) return; 
            const { error } = await adminDb.from('messages').insert({ sender_id: currentUserId, receiver_id: document.getElementById('chat-to').value, space_id: document.getElementById('chat-space').value, content: val }); 
            if (!error) { 
                document.getElementById('chat-input').value = ''; 
                const b = document.getElementById('chat-body');
                b.innerHTML += `<div class="flex flex-col items-end w-full animate-fade-in-up"><div class="bg-black text-white rounded-br-none px-5 py-3 rounded-2xl max-w-[85%] text-sm shadow-sm">${val}</div><span class="text-[10px] text-gray-400 mt-1 px-1">Ahora</span></div>`;
                b.scrollTop = b.scrollHeight;
                // ACTUALIZAR SIDEBAR
                loadMessages();
            } 
        }
        let cal; function openBlockModal(id) { document.getElementById('block-space-id').value = id; document.getElementById('block-modal').classList.remove('hidden'); if(cal) cal.destroy(); cal = flatpickr("#block-dates", { mode: "range", minDate: "today" }); }
        async function confirmBlock() { const d = cal.selectedDates; if(d.length!==2) return alert("Rango incompleto"); const s=d[0].toISOString(); const e=d[1].toISOString(); await adminDb.from('bookings').insert({ space_id: document.getElementById('block-space-id').value, owner_id: currentUserId, renter_id: currentUserId, start_date: s, end_date: e, total_price: 0, status: 'blocked' }); document.getElementById('block-modal').classList.add('hidden'); loadHostingData(); }
        async function createNewUser() { await adminDb.auth.signUp({ email: document.getElementById('new-user-email').value, password: document.getElementById('new-user-pass').value }); alert("Usuario creado"); document.getElementById('user-modal').classList.add('hidden'); loadAdminData(); }
    </script>
</body>
</html>